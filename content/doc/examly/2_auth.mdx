Excellent. Here is the final, fully updated documentation incorporating the `middleware.ts` and `next.config.ts` files.

***

# Authentication System Documentation

This document provides a comprehensive guide to the authentication system in the Examly application, including architecture, setup, configuration, and usage of all related components and hooks.

## Table of Contents
1.  [Architecture Overview](#architecture-overview)
2.  [File Structure](#file-structure)
3.  [Detailed File Contents](#detailed-file-contents)
4.  [Setup Instructions](#setup-instructions)
5.  [Project Configuration](#project-configuration)
6.  [State Management (Zustand)](#state-management-zustand)
7.  [Data Fetching & Mutations (React Query)](#data-fetching--mutations-react-query)
8.  [Authentication Flows](#authentication-flows)
9.  [Core Logic & Services](#core-logic--services)
10. [Hooks](#hooks)
11. [Routing & Middleware](#routing--middleware)
12. [Components](#components)
13. [Styling & Theming](#styling--theming)
14. [Security Considerations](#security-considerations)
15. [Troubleshooting](#troubleshooting)

## Architecture Overview

The authentication system is built on a modern, robust stack designed for scalability and a great developer experience:

-   **Backend & User Management**: **Firebase Authentication** handles user creation, sign-in, and session management. **Firestore** is used to store additional user profile information, such as roles and personal details.
-   **Client-Side State Management**: **Zustand** is used for managing global client-side state, including the current user, loading status, and initialization state. The state is persisted to `localStorage` to maintain sessions across browser tabs and reloads.
-   **Server State & Data Fetching**: **TanStack React Query** manages server state, caching user data, and handling all asynchronous authentication actions (login, register, etc.) as mutations. This provides a robust framework for handling loading states, errors, and data synchronization.
-   **Form Management & Validation**: **React Hook Form** is used for building forms, and **Zod** provides powerful, type-safe schema-based validation for all user input.
-   **Frontend Framework**: **Next.js** with the App Router.
-   **UI Components**: A custom UI library built with **Tailwind CSS** and **Radix UI** primitives, providing a consistent and accessible set of components like Buttons, Inputs, and Modals.
-   **Styling**: **Tailwind CSS** is used for styling, with a comprehensive theme system that supports both light and dark modes.

## File Structure

Here is the relevant file structure for the authentication and core application systems:

```
/app
├── (auth)/                     # Route group for auth pages
│   ├── forgot-password/page.tsx
│   ├── login/page.tsx
│   └── register/page.tsx
├── profile/page.tsx            # User profile page
├── unauthorized/page.tsx       # Access denied page
├── layout.tsx                  # Root layout
├── page.tsx                    # Landing page
├── globals.css                 # Global styles and theme variables
└── ...
/components
├── auth/                       # Authentication-specific components
│   ├── AuthGuard.tsx
│   ├── AuthWrapper.tsx
│   ├── ForgotPasswordForm.tsx
│   ├── GoogleSignInButton.tsx
│   ├── LoginForm.tsx
│   ├── RegisterForm.tsx
│   ├── RoleGuard.tsx
│   └── UserMenu.tsx
├── layout/                     # Authenticated layout components
│   └── Navbar.tsx
├── navigation/                 # Public navigation components
│   ├── Nav.tsx
│   └── Footer.tsx
├── ui/                         # Reusable UI components
│   ├── Button.tsx
│   ├── Checkbox.tsx
│   ├── Input.tsx
│   ├── Label.tsx
│   ├── LoadingSpinner.tsx
│   └── Select.tsx
├── Error.tsx                   # Global error component
└── NotFound.tsx                # 404 component
/hooks
├── useAuth.ts                  # Hook for accessing auth state and methods
└── useAuthMutations.ts         # Hook for auth actions (login, logout, etc.)
/lib
├── firebase/
│   ├── auth.ts                 # Firebase auth service (core logic)
│   └── config.ts               # Firebase initialization
├── validations/
│   └── auth.ts                 # Zod validation schemas
└── utils.ts                    # Utility functions (e.g., cn)
/provider
├── QueryClientProviderWrapper.tsx # React Query provider
└── ThemeProvider.tsx           # Theme provider
/store
├── authStore.ts                # Zustand store for authentication
└── themeStore.ts               # Zustand store for theme
/types
└── auth.ts                     # TypeScript types for authentication
middleware.ts                   # Next.js middleware
next.config.ts                  # Next.js configuration
```

## Detailed File Contents

This section contains the full source code for each file in the system.

### `/app` Directory

<details>
<summary><code>/app/layout.tsx</code></summary>

```typescript
import type { Metadata } from "next";
import "./globals.css";
import ThemeProvider from "@/provider/ThemeProvider";
import NavItems from "@/components/navigation/Nav";
import Footer from "@/components/navigation/Footer";
import { fontSans } from "@/config/fonts";
import { fontMono } from "@/config/fonts";
import { cn } from "@/lib/utils";
import QueryClientProviderWrapper from "@/provider/QueryClientProviderWrapper";

export const metadata: Metadata = {
  title: "Examly App",
  description:
    "Your personal exam coach—generating quizzes, analyzing mistakes, and optimizing study time for peak performance.",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en" suppressHydrationWarning>
      <head>
        {/* Minimal inline script to prevent flash - only sets classes */}
        <script
          dangerouslySetInnerHTML={{
            __html: `
              try {
                const theme = localStorage.getItem("theme-storage") || "system";
                const dark = theme === "dark" || (theme === "system" && matchMedia("(prefers-color-scheme:dark)").matches);
                if (dark) document.documentElement.classList.add("dark");
              } catch(e) {
                if (matchMedia("(prefers-color-scheme:dark)").matches) document.documentElement.classList.add("dark");
              }
            `,
          }}
        />
      </head>
      <body className={cn("antialiased", fontSans.variable, fontMono.variable)}>
        {/* No script - let React handle everything */}
        <ThemeProvider>
          <QueryClientProviderWrapper>
            <NavItems />
            {children}
            <Footer />
          </QueryClientProviderWrapper>
        </ThemeProvider>
      </body>
    </html>
  );
}
```
</details>

<details>
<summary><code>/app/page.tsx</code></summary>

```typescript
"use client";

import CTA from "@/components/home/CTA";
import Features from "@/components/home/Features";
import GettingStarted from "@/components/home/GettingStarted";
import Hero from "@/components/home/Hero";
import Pricing from "@/components/home/Pricing";

const ExamlyLanding = () => {
  return (
    <div className="min-h-screen overflow-hidden text-gray-900 dark:from-gray-900 dark:via-gray-900 dark:to-gray-800 dark:text-white">
      {/* Hero Section */}
      <Hero />
      {/* Features Section */}
      <Features />

      {/* Pricing Section */}
      <Pricing />

      {/* Getting Started Section */}
      <GettingStarted />

      {/* CTA Section */}
      <CTA />
    </div>
  );
};

export default ExamlyLanding;
```
</details>

<details>
<summary><code>/app/globals.css</code></summary>

```css
@import "tailwindcss";
@import "tw-animate-css";

@custom-variant dark (&:where(.dark, .dark *)); /* dark mode styles are applied when an element has the .dark class OR when it's a descendant of an element with .dark class */

/* Color scheme handled by CSS classes */
:root {
  color-scheme: light;
}

:root.dark {
  color-scheme: dark;
}

/* Smooth transitions for theme changes (not initial load) */
*,
*::before,
*::after {
  transition-property: color, background-color, border-color;
  transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
  transition-duration: 150ms;
}

/* Disable transitions on initial page load */
.no-transition * {
  transition: none !important;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
  /* ... truncated for brevity ... */
}

:root {
  --radius: 0.625rem;
  --background: #ffffff;
  --foreground: #1f1a3d;
  /* ... truncated for brevity ... */
}

.dark {
  --background: #1f1a3d;
  --foreground: #f9f7ff;
  /* ... truncated for brevity ... */
}

@layer base {
  * {
    @apply border-border outline-ring/50;
  }
  body {
    @apply bg-background text-foreground;
  }
}
```
</details>

<details>
<summary><code>/app/(auth)/login/page.tsx</code></summary>

```typescript
"use client";

import { LoginForm } from "@/components/auth/LoginForm";
import { useRouter } from "next/navigation";
import React from "react";

export default function Login() {
  const router = useRouter();

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-cyan-100 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900">
      {/* Background Pattern */}
      <div className="bg-grid-slate-100 dark:bg-grid-slate-700/25 absolute inset-0 [mask-image:radial-gradient(ellipse_at_center,white,transparent_75%)] bg-[size:20px_20px]" />

      <div className="relative flex min-h-screen items-center justify-center px-4 py-12">
        <div className="w-full max-w-md space-y-8">
          {/* Logo/Brand Area */}
          <div className="text-center">
            <div className="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-xl bg-gradient-to-r from-indigo-600 to-purple-600">
              {/* SVG Icon */}
            </div>
            <h1 className="text-4xl font-extrabold tracking-tight text-slate-900 dark:text-white">
              Welcome Back
            </h1>
            <p className="mt-2 text-lg text-slate-600 dark:text-slate-300">
              Sign in to continue to your account
            </p>
          </div>

          {/* Login Form Card */}
          <div className="relative">
            {/* Glow effect */}
            <div className="absolute -inset-2 animate-pulse rounded-3xl bg-gradient-to-r from-indigo-600 to-purple-600 opacity-20 blur-lg" />

            {/* Main card */}
            <div className="relative rounded-3xl border border-white/50 bg-white/70 p-8 shadow-2xl backdrop-blur-xl dark:border-slate-700/50 dark:bg-slate-800/70">
              <LoginForm
                onToggleMode={() => {
                  router.push("/register");
                }}
                onForgotPassword={() => router.push("/forgot-password")}
              />
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
```
</details>

<details>
<summary><code>/app/(auth)/register/page.tsx</code></summary>

```typescript
"use client";

import { RegisterForm } from "@/components/auth/RegisterForm";
import { useRouter } from "next/navigation";
import React from "react";

const Registerpage = () => {
  const router = useRouter();
  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-cyan-100 py-16 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900">
      {/* Background Pattern */}
      <div className="bg-grid-slate-100 dark:bg-grid-slate-700/25 absolute inset-0 [mask-image:radial-gradient(ellipse_at_center,white,transparent_75%)] bg-[size:20px_20px]" />

      <div className="relative flex min-h-screen items-center justify-center px-4 py-12">
        <div className="w-full max-w-md space-y-8">
          {/* Logo/Brand Area */}
          <div className="text-center">
             <div className="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-xl bg-gradient-to-r from-indigo-600 to-purple-600">
                {/* SVG Icon */}
            </div>
            <p className="mt-2 text-lg text-slate-600 dark:text-slate-300">
              Please Register to continue
            </p>
          </div>

          {/* Login Form Card */}
          <div className="relative">
            {/* Glow effect */}
            <div className="absolute -inset-2 animate-pulse rounded-3xl bg-gradient-to-r from-indigo-600 to-purple-600 opacity-20 blur-lg" />

            {/* Main card */}
            <div className="relative rounded-3xl border border-white/50 bg-white/70 p-8 shadow-2xl backdrop-blur-xl dark:border-slate-700/50 dark:bg-slate-800/70">
              <RegisterForm onToggleMode={() => router.push("/login")} />
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default Registerpage;
```</details>

<details>
<summary><code>/app/(auth)/forgot-password/page.tsx</code></summary>

```typescript
"use client";

import { ForgotPasswordForm } from "@/components/auth/ForgotPasswordForm";
import { useRouter } from "next/navigation";

const ForgotPasswordPage = () => {
  const router = useRouter();
  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-cyan-100 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900">
      {/* Background Pattern */}
      <div className="bg-grid-slate-100 dark:bg-grid-slate-700/25 absolute inset-0 [mask-image:radial-gradient(ellipse_at_center,white,transparent_75%)] bg-[size:20px_20px]" />

      <div className="relative flex min-h-screen items-center justify-center px-4 py-12">
        <div className="w-full max-w-md space-y-8">
          {/* Logo/Brand Area */}
          <div className="text-center">
             <div className="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-xl bg-gradient-to-r from-indigo-600 to-purple-600">
              {/* SVG Icon */}
            </div>
            <h1 className="text-4xl font-extrabold tracking-tight text-slate-900 dark:text-white">
              Welcome Back
            </h1>
            <p className="mt-2 text-lg text-slate-600 dark:text-slate-300">
              Sign in to continue to your account
            </p>
          </div>

          {/* Form Card */}
          <div className="relative">
            {/* Glow effect */}
            <div className="absolute -inset-2 animate-pulse rounded-3xl bg-gradient-to-r from-indigo-600 to-purple-600 opacity-20 blur-lg" />

            {/* Main card */}
            <div className="relative rounded-3xl border border-white/50 bg-white/70 p-8 shadow-2xl backdrop-blur-xl dark:border-slate-700/50 dark:bg-slate-800/70">
              <ForgotPasswordForm onBack={() => router.push("/login")} />
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ForgotPasswordPage;
```
</details>

<details>
<summary><code>/app/profile/page.tsx</code></summary>

```typescript
// app/profile/page.tsx
"use client";

import { useState } from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { Mail, Phone, Edit, Save, X } from "lucide-react";
import { AuthGuard } from "@/components/auth/AuthGuard";
import { useAuth } from "@/hooks/useAuth";
import { useAuthMutations } from "@/hooks/useAuthMutations";
import {
  updateProfileSchema,
  UpdateProfileFormData,
} from "@/lib/validations/auth";
import { Button } from "@/components/ui/Button";
import { Input } from "@/components/ui/Input";
import { Label } from "@/components/ui/Label";

export default function ProfilePage() {
  const [isEditing, setIsEditing] = useState(false);
  const { user } = useAuth();
  const { updateProfile } = useAuthMutations();

  const {
    register,
    handleSubmit,
    formState: { errors, isDirty },
    reset,
  } = useForm<UpdateProfileFormData>({
    resolver: zodResolver(updateProfileSchema),
    defaultValues: {
      firstName: user?.profile?.firstName || "",
      lastName: user?.profile?.lastName || "",
      phone: user?.profile?.phone || "",
      bio: user?.profile?.bio || "",
    },
  });

  const onSubmit = async (data: UpdateProfileFormData) => {
    try {
      await updateProfile.mutateAsync({
        profile: {
          ...user?.profile,
          ...data,
        },
      });
      setIsEditing(false);
    } catch (error) {
      console.error("Failed to update profile:", error);
    }
  };

  const handleCancel = () => {
    reset();
    setIsEditing(false);
  };

  return (
    <AuthGuard>
      <div className="mx-auto max-w-4xl px-4 py-8 sm:px-6 lg:px-8">
        {/* Profile Details Card */}
      </div>
    </AuthGuard>
  );
}
```
</details>

<details>
<summary><code>/app/unauthorized/page.tsx</code></summary>

```typescript
// app/unauthorized/page.tsx
"use client";

import { motion } from "framer-motion";
import { Shield, ArrowLeft } from "lucide-react";
import { Button } from "@/components/ui/Button";
import Link from "next/link";

export default function UnauthorizedPage() {
  return (
    <div className="flex min-h-screen items-center justify-center bg-gray-50 p-4 dark:bg-gray-900">
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        className="w-full max-w-md text-center"
      >
        <motion.div
          initial={{ scale: 0 }}
          animate={{ scale: 1 }}
          transition={{ delay: 0.2 }}
          className="mx-auto mb-6 flex h-20 w-20 items-center justify-center rounded-full bg-red-100 dark:bg-red-900/20"
        >
          <Shield className="h-10 w-10 text-red-600 dark:text-red-400" />
        </motion.div>

        <h1 className="mb-4 text-3xl font-bold text-gray-900 dark:text-white">
          Access Denied
        </h1>

        <p className="mb-8 text-gray-600 dark:text-gray-400">
          You don&apos;t have permission to access this page. Please contact
          your administrator if you believe this is an error.
        </p>

        <div className="space-y-4">
          <Button asChild className="w-full">
            <Link href="/dashboard">
              <ArrowLeft className="mr-2 h-4 w-4" />
              Go to Dashboard
            </Link>
          </Button>

          <Button variant="outline" asChild className="w-full">
            <Link href="/">Go to Home</Link>
          </Button>
        </div>
      </motion.div>
    </div>
  );
}
```
</details>

### `/components` Directory

<details>
<summary><code>/components/auth/AuthGuard.tsx</code></summary>

```typescript
// components/auth/AuthGuard.tsx
"use client";

import { useEffect, ReactNode } from "react";
import { useRouter } from "next/navigation";
import { useAuth } from "@/hooks/useAuth";
import { UserRole } from "@/types/auth";
import { LoadingSpinner } from "@/components/ui/LoadingSpinner";

interface AuthGuardProps {
  children: ReactNode;
  requiredRole?: UserRole;
  requireAuth?: boolean;
  redirectTo?: string;
}

export const AuthGuard = ({
  children,
  requiredRole,
  requireAuth = true,
  redirectTo = "/auth",
}: AuthGuardProps) => {
  const { user, isLoading, isInitialized, hasRole } = useAuth();
  const router = useRouter();

  useEffect(() => {
    if (!isInitialized || isLoading) return;

    if (requireAuth && !user) {
      router.push(redirectTo);
      return;
    }

    if (requiredRole && !hasRole(requiredRole)) {
      router.push("/unauthorized");
      return;
    }
  }, [
    user,
    isLoading,
    isInitialized,
    requiredRole,
    requireAuth,
    redirectTo,
    router,
    hasRole,
  ]);

  if (!isInitialized || isLoading) {
    return <LoadingSpinner />;
  }

  if (requireAuth && !user) {
    return null;
  }

  if (requiredRole && !hasRole(requiredRole)) {
    return null;
  }

  return <>{children}</>;
};
```
</details>

<details>
<summary><code>/components/auth/AuthWrapper.tsx</code></summary>

```typescript
// components/auth/AuthWrapper.tsx
"use client";

import { useState } from "react";
import { AnimatePresence } from "framer-motion";
import { LoginForm } from "./LoginForm";
import { RegisterForm } from "./RegisterForm";
import { ForgotPasswordForm } from "./ForgotPasswordForm";

type AuthMode = "login" | "register" | "forgot-password";

export const AuthWrapper = () => {
  const [mode, setMode] = useState<AuthMode>("login");

  const handleToggleMode = () => {
    setMode(mode === "login" ? "register" : "login");
  };

  const handleForgotPassword = () => {
    setMode("forgot-password");
  };

  const handleBackToLogin = () => {
    setMode("login");
  };

  return (
    <div className="flex min-h-screen items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 p-4 dark:from-gray-900 dark:to-gray-800">
      <AnimatePresence mode="wait">
        {mode === "login" && (
          <LoginForm
            key="login"
            onToggleMode={handleToggleMode}
            onForgotPassword={handleForgotPassword}
          />
        )}
        {mode === "register" && (
          <RegisterForm key="register" onToggleMode={handleToggleMode} />
        )}
        {mode === "forgot-password" && (
          <ForgotPasswordForm
            key="forgot-password"
            onBack={handleBackToLogin}
          />
        )}
      </AnimatePresence>
    </div>
  );
};
```
</details>

<details>
<summary><code>/components/auth/ForgotPasswordForm.tsx</code></summary>

```typescript
// components/auth/ForgotPasswordForm.tsx
"use client";

import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { motion } from "framer-motion";
import { Mail, ArrowLeft, Send } from "lucide-react";
import {
  resetPasswordSchema,
  ResetPasswordFormData,
} from "@/lib/validations/auth";
import { useAuthMutations } from "@/hooks/useAuthMutations";
import { Button } from "@/components/ui/Button";
import { Input } from "@/components/ui/Input";
import { Label } from "@/components/ui/Label";

interface ForgotPasswordFormProps {
  onBack: () => void;
}

export const ForgotPasswordForm = ({ onBack }: ForgotPasswordFormProps) => {
  const { resetPassword } = useAuthMutations();

  const {
    register,
    handleSubmit,
    formState: { errors, isValid },
  } = useForm<ResetPasswordFormData>({
    resolver: zodResolver(resetPasswordSchema),
    mode: "onChange",
  });

  const onSubmit = (data: ResetPasswordFormData) => {
    resetPassword.mutate(data.email);
  };

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      exit={{ opacity: 0, y: -20 }}
      transition={{ duration: 0.3 }}
      className="mx-auto w-full max-w-md"
    >
      <div className="rounded-2xl border border-gray-200 bg-white p-8 shadow-xl dark:border-gray-700 dark:bg-gray-900">
        <button
          onClick={onBack}
          className="mb-6 flex items-center text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200"
        >
          <ArrowLeft className="mr-2 h-5 w-5" />
          Back to sign in
        </button>

        <div className="mb-8 text-center">
          <h1 className="mb-2 text-3xl font-bold text-gray-900 dark:text-white">
            Reset Password
          </h1>
          <p className="text-gray-600 dark:text-gray-400">
            Enter your email address and we&apos;ll send you a link to reset
            your password
          </p>
        </div>

        <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
          {/* Form fields */}
        </form>
      </div>
    </motion.div>
  );
};
```
</details>

<details>
<summary><code>/components/auth/LoginForm.tsx</code></summary>

```typescript
// components/auth/LoginForm.tsx
"use client";

import { useState } from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { motion } from "framer-motion";
import { Eye, EyeOff, Mail, Lock, LogIn } from "lucide-react";
import { loginSchema, LoginFormData } from "@/lib/validations/auth";
import { useAuthMutations } from "@/hooks/useAuthMutations";
import { Button } from "@/components/ui/Button";
import { Input } from "@/components/ui/Input";
import { Label } from "@/components/ui/Label";
import { Checkbox } from "@/components/ui/Checkbox";
import { GoogleSignInButton } from "@/components/auth/GoogleSignInButton";

interface LoginFormProps {
  onToggleMode: () => void;
  onForgotPassword: () => void;
}

export const LoginForm = ({
  onToggleMode,
  onForgotPassword,
}: LoginFormProps) => {
  const [showPassword, setShowPassword] = useState(false);
  const { login } = useAuthMutations();

  const {
    register,
    handleSubmit,
    formState: { errors, isValid },
  } = useForm<LoginFormData>({
    resolver: zodResolver(loginSchema),
    mode: "onChange",
  });

  const onSubmit = (data: LoginFormData) => {
    login.mutate(data);
  };

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      exit={{ opacity: 0, y: -20 }}
      transition={{ duration: 0.3 }}
      className="mx-auto w-full max-w-md"
    >
      <div className="rounded-2xl border border-gray-200 bg-white p-8 shadow-xl dark:border-gray-700 dark:bg-gray-900">
        <div className="mb-8 text-center">
          <h1 className="mb-2 text-3xl font-bold text-gray-900 dark:text-white">
            Welcome Back
          </h1>
          <p className="text-gray-600 dark:text-gray-400">
            Sign in to your account to continue
          </p>
        </div>

        <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
          {/* Form fields */}
        </form>

        <div className="mt-6">
          <div className="relative">
            <div className="absolute inset-0 flex items-center">
              <div className="w-full border-t border-gray-300 dark:border-gray-600" />
            </div>
            <div className="relative flex justify-center text-sm">
              <span className="bg-white px-2 text-gray-500 dark:bg-gray-900">
                Or continue with
              </span>
            </div>
          </div>
          <div className="mt-6">
            <GoogleSignInButton />
          </div>
        </div>

        <div className="mt-6 text-center">
          <p className="text-gray-600 dark:text-gray-400">
            Don&apos;t have an account?{" "}
            <button
              onClick={onToggleMode}
              className="font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400 dark:hover:text-blue-300"
            >
              Sign up
            </button>
          </p>
        </div>
      </div>
    </motion.div>
  );
};
```
</details>

<details>
<summary><code>/components/auth/RegisterForm.tsx</code></summary>

```typescript
// components/auth/RegisterForm.tsx
"use client";

import { useState } from "react";
import { Controller, useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { motion } from "framer-motion";
import { Eye, EyeOff, Mail, Lock, User, UserPlus } from "lucide-react";
import { registerSchema, RegisterFormData } from "@/lib/validations/auth";
import { useAuthMutations } from "@/hooks/useAuthMutations";
import { Button } from "@/components/ui/Button";
import { Input } from "@/components/ui/Input";
import { Label } from "@/components/ui/Label";
import {
  Select,
  SelectTrigger,
  SelectValue,
  SelectContent,
  SelectItem,
} from "@/components/ui/Select";
import { GoogleSignInButton } from "@/components/auth/GoogleSignInButton";

interface RegisterFormProps {
  onToggleMode: () => void;
}

export const RegisterForm = ({ onToggleMode }: RegisterFormProps) => {
  const [showPassword, setShowPassword] = useState(false);
  const [showConfirmPassword, setShowConfirmPassword] = useState(false);
  const { register: registerMutation } = useAuthMutations();

  const {
    register,
    handleSubmit,
    control,
    formState: { errors, isValid },
  } = useForm<RegisterFormData>({
    resolver: zodResolver(registerSchema),
    mode: "onChange",
    defaultValues: {
      firstName: "",
      lastName: "",
      email: "",
      role: "student",
      password: "",
      confirmPassword: "",
    },
  });

  const onSubmit = (data: RegisterFormData) => {
    registerMutation.mutate(data);
  };

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      exit={{ opacity: 0, y: -20 }}
      transition={{ duration: 0.3 }}
      className="mx-auto w-full max-w-md"
    >
      <div className="rounded-2xl border border-gray-200 bg-white p-8 shadow-xl dark:border-gray-700 dark:bg-gray-900">
        <div className="mb-8 text-center">
          <h1 className="mb-2 text-3xl font-bold text-gray-900 dark:text-white">
            Create Account
          </h1>
          <p className="text-gray-600 dark:text-gray-400">
            Sign up to get started with your learning journey
          </p>
        </div>

        <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <Label
                htmlFor="firstName"
                className="text-gray-700 dark:text-gray-300"
              >
                First Name
              </Label>
              <div className="relative mt-2">
                <User className="absolute top-3 left-3 h-5 w-5 text-gray-400" />
                <Input
                  id="firstName"
                  type="text"
                  autoComplete="given-name"
                  placeholder="First name"
                  className={`pl-10 ${errors.firstName ? "border-red-500" : ""}`}
                  {...register("firstName")}
                />
              </div>
              {errors.firstName && (
                <motion.p
                  initial={{ opacity: 0, height: 0 }}
                  animate={{ opacity: 1, height: "auto" }}
                  className="mt-1 text-sm text-red-600"
                >
                  {errors.firstName.message}
                </motion.p>
              )}
            </div>

            <div>
              <Label
                htmlFor="lastName"
                className="text-gray-700 dark:text-gray-300"
              >
                Last Name
              </Label>
              <div className="relative mt-2">
                <User className="absolute top-3 left-3 h-5 w-5 text-gray-400" />
                <Input
                  id="lastName"
                  type="text"
                  autoComplete="family-name"
                  placeholder="Last name"
                  className={`pl-10 ${errors.lastName ? "border-red-500" : ""}`}
                  {...register("lastName")}
                />
              </div>
              {errors.lastName && (
                <motion.p
                  initial={{ opacity: 0, height: 0 }}
                  animate={{ opacity: 1, height: "auto" }}
                  className="mt-1 text-sm text-red-600"
                >
                  {errors.lastName.message}
                </motion.p>
              )}
            </div>
          </div>

          <div>
            <Label htmlFor="email" className="text-gray-700 dark:text-gray-300">
              Email Address
            </Label>
            <div className="relative mt-2">
              <Mail className="absolute top-3 left-3 h-5 w-5 text-gray-400" />
              <Input
                id="email"
                type="email"
                autoComplete="email"
                placeholder="Enter your email"
                className={`pl-10 ${errors.email ? "border-red-500" : ""}`}
                {...register("email")}
              />
            </div>
            {errors.email && (
              <motion.p
                initial={{ opacity: 0, height: 0 }}
                animate={{ opacity: 1, height: "auto" }}
                className="mt-1 text-sm text-red-600"
              >
                {errors.email.message}
              </motion.p>
            )}
          </div>

          <div>
            <Label htmlFor="role" className="text-gray-700 dark:text-gray-300">
              I am a
            </Label>
            <div className="mt-2">
              <Controller
                name="role"
                control={control}
                render={({ field }) => (
                  <Select
                    value={field.value}
                    onValueChange={field.onChange}
                    defaultValue="student"
                  >
                    <SelectTrigger className="w-full">
                      <SelectValue placeholder="Select role" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="student">Student</SelectItem>
                      <SelectItem value="teacher">Teacher</SelectItem>
                    </SelectContent>
                  </Select>
                )}
              />
            </div>
            {errors.role && (
              <motion.p
                initial={{ opacity: 0, height: 0 }}
                animate={{ opacity: 1, height: "auto" }}
                className="mt-1 text-sm text-red-600"
              >
                {errors.role.message}
              </motion.p>
            )}
          </div>

          <div>
            <Label
              htmlFor="password"
              className="text-gray-700 dark:text-gray-300"
            >
              Password
            </Label>
            <div className="relative mt-2">
              <Lock className="absolute top-3 left-3 h-5 w-5 text-gray-400" />
              <Input
                id="password"
                type={showPassword ? "text" : "password"}
                autoComplete="new-password"
                placeholder="Create a password"
                className={`pr-10 pl-10 ${errors.password ? "border-red-500" : ""}`}
                {...register("password")}
              />
              <button
                type="button"
                onClick={() => setShowPassword(!showPassword)}
                className="absolute top-3 right-3 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
              >
                {showPassword ? (
                  <EyeOff className="h-5 w-5" />
                ) : (
                  <Eye className="h-5 w-5" />
                )}
              </button>
            </div>
            {errors.password && (
              <motion.p
                initial={{ opacity: 0, height: 0 }}
                animate={{ opacity: 1, height: "auto" }}
                className="mt-1 text-sm text-red-600"
              >
                {errors.password.message}
              </motion.p>
            )}
          </div>

          <div>
            <Label
              htmlFor="confirmPassword"
              className="text-gray-700 dark:text-gray-300"
            >
              Confirm Password
            </Label>
            <div className="relative mt-2">
              <Lock className="absolute top-3 left-3 h-5 w-5 text-gray-400" />
              <Input
                id="confirmPassword"
                type={showConfirmPassword ? "text" : "password"}
                autoComplete="new-password"
                placeholder="Confirm your password"
                className={`pr-10 pl-10 ${errors.confirmPassword ? "border-red-500" : ""}`}
                {...register("confirmPassword")}
              />
              <button
                type="button"
                onClick={() => setShowConfirmPassword(!showConfirmPassword)}
                className="absolute top-3 right-3 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
              >
                {showConfirmPassword ? (
                  <EyeOff className="h-5 w-5" />
                ) : (
                  <Eye className="h-5 w-5" />
                )}
              </button>
            </div>
            {errors.confirmPassword && (
              <motion.p
                initial={{ opacity: 0, height: 0 }}
                animate={{ opacity: 1, height: "auto" }}
                className="mt-1 text-sm text-red-600"
              >
                {errors.confirmPassword.message}
              </motion.p>
            )}
          </div>

          <Button
            type="submit"
            disabled={!isValid}
            className="w-full rounded-lg bg-blue-600 py-3 font-medium text-white transition-colors hover:bg-blue-700 disabled:cursor-not-allowed disabled:opacity-50"
          >
            {registerMutation.isPending ? (
              <div className="flex items-center justify-center">
                <div className="mr-2 h-5 w-5 animate-spin rounded-full border-b-2 border-white" />
                Creating account...
              </div>
            ) : (
              <div className="flex items-center justify-center">
                <UserPlus className="mr-2 h-5 w-5" />
                Create Account
              </div>
            )}
          </Button>
        </form>

        <div className="mt-6">
          <div className="relative">
            <div className="absolute inset-0 flex items-center">
              <div className="w-full border-t border-gray-300 dark:border-gray-600" />
            </div>
            <div className="relative flex justify-center text-sm">
              <span className="bg-white px-2 text-gray-500 dark:bg-gray-900">
                Or continue with
              </span>
            </div>
          </div>

          <div className="mt-6">
            <GoogleSignInButton />
          </div>
        </div>

        <div className="mt-6 text-center">
          <p className="text-gray-600 dark:text-gray-400">
            Already have an account?{" "}
            <button
              onClick={onToggleMode}
              className="font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400 dark:hover:text-blue-300"
            >
              Sign in
            </button>
          </p>
        </div>
      </div>
    </motion.div>
  );
};
```
</details>

<details>
<summary><code>/components/ui/Button.tsx</code></summary>

```typescript
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"
import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",
        destructive: "bg-destructive text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline: "border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",
        secondary: "bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2 has-[>svg]:px-3",
        sm: "h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",
        lg: "h-10 rounded-md px-6 has-[>svg]:px-4",
        icon: "size-9",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

function Button({
  className,
  variant,
  size,
  asChild = false,
  ...props
}: React.ComponentProps<"button"> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean
  }) {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      data-slot="button"
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  )
}

export { Button, buttonVariants }
```
</details>

<details>
<summary><code>/components/ui/Input.tsx</code></summary>

```typescript
// components/ui/Input.tsx
import { forwardRef, InputHTMLAttributes } from "react";
import { cn } from "@/lib/utils";

const Input = forwardRef<
  HTMLInputElement,
  InputHTMLAttributes<HTMLInputElement>
>(({ className, type, ...props }, ref) => {
  return (
    <input
      type={type}
      className={cn(
        "flex h-10 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm ring-offset-white file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-gray-500 focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2 focus-visible:outline-none disabled:cursor-not-allowed disabled:opacity-50 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 dark:ring-offset-gray-900 dark:placeholder:text-gray-400 dark:focus-visible:ring-blue-400",
        className,
      )}
      ref={ref}
      {...props}
    />
  );
});
Input.displayName = "Input";

export { Input };
```
</details>

### `/hooks` Directory

<details>
<summary><code>/hooks/useAuth.ts</code></summary>

```typescript
// hooks/useAuth.ts
import { useEffect } from "react";
import { onAuthStateChanged, User } from "firebase/auth";
import { useQuery, useQueryClient } from "@tanstack/react-query";
import { auth } from "@/lib/firebase/config";
import { AuthService } from "@/lib/firebase/auth";
import { useAuthStore } from "@/store/authStore";
import { AuthUser, UserRole } from "@/types/auth";

export const useAuth = () => {
  const {
    user,
    isLoading,
    isInitialized,
    error,
    setUser,
    setLoading,
    setInitialized,
    setError,
    clearError,
    reset,
  } = useAuthStore();

  const queryClient = useQueryClient();

  const { data: userData, isLoading: isUserLoading } = useQuery({
    queryKey: ["user", user?.uid],
    queryFn: async (): Promise<AuthUser | null> => {
      if (!auth.currentUser) return null;
      return await AuthService.getUserData(auth.currentUser);
    },
    enabled: !!user?.uid,
    staleTime: 5 * 60 * 1000,
    gcTime: 10 * 60 * 1000,
  });

  useEffect(() => {
    setLoading(true);
    const unsubscribe = onAuthStateChanged(
      auth,
      async (firebaseUser: User | null) => {
        try {
          if (firebaseUser) {
            const authUser = await AuthService.getUserData(firebaseUser);
            setUser(authUser);
            queryClient.setQueryData(["user", authUser.uid], authUser);
          } else {
            setUser(null);
            queryClient.clear();
          }
        } catch (error) {
          setError(error instanceof Error ? error.message : "An unexpected error occurred");
        } finally {
          setLoading(false);
          setInitialized(true);
        }
      },
    );
    return unsubscribe;
  }, [setUser, setLoading, setInitialized, setError, queryClient]);

  const signOut = async () => {
    try {
      setLoading(true);
      await AuthService.signOut();
      reset();
      queryClient.clear();
    } catch (error) {
      setError(error instanceof Error ? error.message : "An unexpected error occurred");
    }
  };

  return {
    user: userData || user,
    isLoading: isLoading || isUserLoading,
    isInitialized,
    error,
    signOut,
    hasRole: (role: string) => AuthService.hasRole(userData || user, role as UserRole),
  };
};
```
</details>

<details>
<summary><code>/hooks/useAuthMutations.ts</code></summary>

```typescript
// hooks/useAuthMutations.ts
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { AuthService } from "@/lib/firebase/auth";
import { LoginCredentials, RegisterCredentials, AuthUser } from "@/types/auth";
import { useAuthStore } from "@/store/authStore";
import { toast } from "react-hot-toast";

export const useAuthMutations = () => {
  const queryClient = useQueryClient();
  const { setUser, setError } = useAuthStore();

  const loginMutation = useMutation({
    mutationFn: (credentials: LoginCredentials) => AuthService.signInWithCredentials(credentials),
    onSuccess: (user: AuthUser) => {
      setUser(user);
      queryClient.setQueryData(["user", user.uid], user);
      toast.success("Successfully signed in!");
    },
    onError: (error: Error) => {
      setError(error.message);
      toast.error(error.message);
    },
  });

  const googleSignInMutation = useMutation({
    mutationFn: () => AuthService.signInWithGoogle(),
    onSuccess: (user: AuthUser) => {
      setUser(user);
      queryClient.setQueryData(["user", user.uid], user);
      toast.success("Successfully signed in with Google!");
    },
    onError: (error: Error) => {
      setError(error.message);
      toast.error(error.message);
    },
  });

  const registerMutation = useMutation({
    mutationFn: (credentials: RegisterCredentials) => AuthService.registerWithCredentials(credentials),
    onSuccess: (user: AuthUser) => {
      setUser(user);
      queryClient.setQueryData(["user", user.uid], user);
      toast.success("Account created successfully! Please verify your email.");
    },
    onError: (error: Error) => {
      setError(error.message);
      toast.error(error.message);
    },
  });

  const resetPasswordMutation = useMutation({
    mutationFn: (email: string) => AuthService.resetPassword(email),
    onSuccess: () => {
      toast.success("Password reset email sent!");
    },
    onError: (error: Error) => {
      toast.error(error.message);
    },
  });

  return {
    login: loginMutation,
    googleSignIn: googleSignInMutation,
    register: registerMutation,
    resetPassword: resetPasswordMutation,
  };
};
```
</details>

### `/lib` Directory

<details>
<summary><code>/lib/firebase/auth.ts</code></summary>

```typescript
// lib/firebase/auth.ts
import {
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  signInWithPopup,
  GoogleAuthProvider,
  signOut,
  sendPasswordResetEmail,
  updateProfile,
  User,
  UserCredential,
} from "firebase/auth";
import {
  doc,
  setDoc,
  getDoc,
  serverTimestamp,
} from "firebase/firestore";
import { auth, db } from "./config";
import {
  AuthUser,
  LoginCredentials,
  RegisterCredentials,
  UserRole,
} from "@/types/auth";

const googleProvider = new GoogleAuthProvider();

export class AuthService {
  static async signInWithCredentials({ email, password }: LoginCredentials): Promise<AuthUser> {
    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      return await this.getUserData(userCredential.user);
    } catch (error) {
      throw this.handleAuthError(error);
    }
  }

  static async signInWithGoogle(): Promise<AuthUser> {
    try {
      const userCredential = await signInWithPopup(auth, googleProvider);
      const userDoc = await getDoc(doc(db, "users", userCredential.user.uid));
      if (!userDoc.exists()) {
        await this.createUserProfile(userCredential.user, { role: "student" });
      }
      return await this.getUserData(userCredential.user);
    } catch (error) {
      throw this.handleAuthError(error);
    }
  }

  static async registerWithCredentials(credentials: RegisterCredentials): Promise<AuthUser> {
    try {
      const { email, password, firstName, lastName, role = "student" } = credentials;
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      await updateProfile(userCredential.user, { displayName: `${firstName} ${lastName}` });
      await this.createUserProfile(userCredential.user, { role, firstName, lastName });
      return await this.getUserData(userCredential.user);
    } catch (error) {
      throw this.handleAuthError(error);
    }
  }

  static async createUserProfile(firebaseUser: User, additionalData: { role: UserRole; firstName?: string; lastName?: string; }) {
    const userRef = doc(db, "users", firebaseUser.uid);
    const userData = {
      uid: firebaseUser.uid,
      email: firebaseUser.email,
      displayName: firebaseUser.displayName,
      role: additionalData.role,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
      profile: {
        firstName: additionalData.firstName || "",
        lastName: additionalData.lastName || "",
      },
    };
    await setDoc(userRef, userData);
  }

  static async getUserData(firebaseUser: User): Promise<AuthUser> {
    const userRef = doc(db, "users", firebaseUser.uid);
    const userSnap = await getDoc(userRef);
    if (userSnap.exists()) {
      const userData = userSnap.data();
      return {
        uid: firebaseUser.uid,
        email: firebaseUser.email,
        displayName: firebaseUser.displayName,
        emailVerified: firebaseUser.emailVerified,
        role: userData.role || "student",
        createdAt: userData.createdAt?.toDate() || new Date(),
        updatedAt: userData.updatedAt?.toDate() || new Date(),
        profile: userData.profile,
      } as AuthUser;
    } else {
      await this.createUserProfile(firebaseUser, { role: "student" });
      return this.getUserData(firebaseUser);
    }
  }

  static async signOut(): Promise<void> {
    await signOut(auth);
  }

  static async resetPassword(email: string): Promise<void> {
    await sendPasswordResetEmail(auth, email);
  }

  static hasRole(user: AuthUser | null, requiredRole: UserRole): boolean {
    if (!user) return false;
    const roleHierarchy: Record<UserRole, number> = {
      guest: 0,
      student: 1,
      teacher: 2,
      admin: 3,
      "super-admin": 4,
    };
    return roleHierarchy[user.role] >= roleHierarchy[requiredRole];
  }

  private static handleAuthError(error: unknown): Error {
    const code = (error as { code?: string }).code;
    switch (code) {
      case "auth/user-not-found": return new Error("No account found with this email.");
      case "auth/wrong-password": return new Error("Incorrect password.");
      case "auth/email-already-in-use": return new Error("This email is already registered.");
      default: return new Error("An unexpected error occurred.");
    }
  }
}
```
</details>

<details>
<summary><code>/lib/validations/auth.ts</code></summary>

```typescript
// lib/validations/auth.ts
import { z } from "zod";

export const loginSchema = z.object({
  email: z.email("Please enter a valid email address"),
  password: z
    .string()
    .min(1, "Password is required")
    .min(6, "Password must be at least 6 characters"),
  rememberMe: z.boolean().optional(),
});

export const registerSchema = z
  .object({
    firstName: z
      .string()
      .min(1, "First name is required")
      .min(2, "First name must be at least 2 characters"),
    lastName: z
      .string()
      .min(1, "Last name is required")
      .min(2, "Last name must be at least 2 characters"),
    email: z
      .string()
      .min(1, "Email is required")
      .email("Please enter a valid email address"),
    password: z
      .string()
      .min(1, "Password is required")
      .min(8, "Password must be at least 8 characters")
      .regex(
        /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]/,
        "Password must contain at least one uppercase letter, one lowercase letter, one number, and one special character",
      ),
    confirmPassword: z.string().min(1, "Please confirm your password"),
    role: z.enum(["student", "teacher"]),
  })
  .refine((data) => data.password === data.confirmPassword, {
    message: "Passwords do not match",
    path: ["confirmPassword"],
  });

export const resetPasswordSchema = z.object({
  email: z.email("Please enter a valid email address"),
});

export const updateProfileSchema = z.object({
  firstName: z
    .string()
    .min(2, "First name must be at least 2 characters")
    .optional(),
  lastName: z
    .string()
    .min(2, "Last name must be at least 2 characters")
    .optional(),
  phone: z
    .string()
    .regex(/^\+?[\d\s-()]+$/, "Please enter a valid phone number")
    .optional()
    .or(z.literal("")),
  bio: z.string().max(500, "Bio must be less than 500 characters").optional(),
});

export type LoginFormData = z.infer<typeof loginSchema>;
export type RegisterFormData = z.infer<typeof registerSchema>;
export type ResetPasswordFormData = z.infer<typeof resetPasswordSchema>;
export type UpdateProfileFormData = z.infer<typeof updateProfileSchema>;
```
</details>

### Root Files

<details>
<summary><code>middleware.ts</code></summary>

```typescript
import { NextResponse } from "next/server";
import type { NextRequest } from "next/server";

export function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl;

  // Protected routes that require authentication
  const protectedRoutes = [
    "/dashboard",
    "/profile",
    "/settings",
    "/exams",
    "/students",
    "/analytics",
  ];

  // Admin-only routes
  const adminRoutes = ["/admin", "/users", "/system"];

  // Teacher-only routes
  const teacherRoutes = ["/students", "/analytics", "/create-exam"];

  // Check if the current path is protected
  const isProtectedRoute = protectedRoutes.some((route) =>
    pathname.startsWith(route),
  );

  const isAdminRoute = adminRoutes.some((route) => pathname.startsWith(route));

  const isTeacherRoute = teacherRoutes.some((route) =>
    pathname.startsWith(route),
  );

  // Redirect to auth page for protected routes
  if (isProtectedRoute) {
    // This will be handled by AuthGuard on the client side
    // Middleware just ensures the route exists
    return NextResponse.next();
  }

  // Redirect authenticated users away from auth page
  if (pathname.startsWith("/auth")) {
    // This will be handled by the auth page component
    return NextResponse.next();
  }

  return NextResponse.next();
}

export const config = {
  matcher: [
    /*
     * Match all request paths except for the ones starting with:
     * - api (API routes)
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     */
    "/((?!api|_next/static|_next/image|favicon.ico).*)",
  ],
};
```
</details>

<details>
<summary><code>next.config.ts</code></summary>

```typescript
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
  reactStrictMode: true,
  images: {
    remotePatterns: [
      {
        protocol: "https",
        hostname: "lh3.googleusercontent.com",
        port: "",
        pathname: "/a/**",
      },
      {
        protocol: "https",
        hostname: "firebasestorage.googleapis.com",
        port: "",
        pathname: "/**",
      },
    ],
  },
};

export default nextConfig;
```
</details>

***

## Setup Instructions

### 1. Prerequisites
-   Node.js v16.8 or later
-   npm, yarn, or pnpm
-   A Firebase project with **Authentication** (Email/Password and Google providers enabled) and **Firestore** activated.

### 2. Environment Setup

Create a `.env.local` file in the project root with your Firebase project credentials:

```env
# Firebase Configuration
NEXT_PUBLIC_FIREBASE_API_KEY=your_api_key
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=your_auth_domain
NEXT_PUBLIC_FIREBASE_PROJECT_ID=your_project_id
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=your_storage_bucket
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=your_messaging_sender_id
NEXT_PUBLIC_FIREBASE_APP_ID=your_app_id
```

### 3. Install Dependencies

Install the necessary packages from your `package.json` or add the following:

```bash
npm install firebase @tanstack/react-query zustand zod @hookform/resolvers react-hook-form framer-motion lucide-react clsx tailwind-merge
```

## Project Configuration

### Firebase Initialization (`lib/firebase/config.ts`)
This file initializes and exports the Firebase app instance, Auth, and Firestore services, reading credentials from environment variables.

### Next.js Configuration (`next.config.ts`)
This file contains the configuration for the Next.js application. For the authentication system, the most relevant part is the `images` configuration, which is necessary to allow displaying user profile pictures from external sources securely.

-   **`reactStrictMode`**: Enabled for highlighting potential problems in the app.
-   **`images.remotePatterns`**: This array whitelists specific domains for Next.js's Image Optimization. We have whitelisted:
    -   `lh3.googleusercontent.com`: To display profile pictures for users who sign in with Google.
    -   `firebasestorage.googleapis.com`: To display user-uploaded content, such as custom profile pictures, stored in Firebase Storage.

## State Management (Zustand)

### Auth Store (`store/authStore.ts`)
Manages global authentication state. It uses `zustand/middleware/persist` to save the user object to `localStorage`, enabling persistent login sessions.

### Theme Store (`stores/themeStore.ts`)
Manages the application's theme (light, dark, or system) and persists the choice to `localStorage`. The `ThemeProvider` component consumes this store to apply the correct theme classes to the `<html>` element.

## Data Fetching & Mutations (React Query)

### Provider (`provider/QueryClientProviderWrapper.tsx`)
This simple wrapper component provides the React Query client to the entire application tree.

## Authentication Flows

1.  **User Registration**: A user provides their name, email, password, and role. The `useAuthMutations` hook calls the `AuthService.registerWithCredentials` method. On success, a new user is created in Firebase Auth, a corresponding user document is created in Firestore, and a verification email is sent.
2.  **User Login**: A user signs in with email/password or Google. `useAuthMutations` handles the logic, calling the appropriate `AuthService` method. On success, the user data is fetched from Firestore, and the `authStore` is updated.
3.  **Password Reset**: A user enters their email on the "Forgot Password" page. An email with a password reset link is sent via `AuthService.resetPassword`.
4.  **Session Management**: `onAuthStateChanged` listener in `useAuth` hook keeps the client-side state synchronized with Firebase's authentication state. The user object in `authStore` is hydrated from `localStorage` on initial load for a seamless experience.

## Core Logic & Services

### Firebase Auth Service (`lib/firebase/auth.ts`)
The `AuthService` class is the single source of truth for all Firebase authentication and user-related Firestore operations. It encapsulates all direct interactions with Firebase, providing a clean, reusable API for the rest of the application.

-   **Methods**: `signInWithCredentials`, `signInWithGoogle`, `registerWithCredentials`, `signOut`, `resetPassword`, `updateUserProfile`, `getUserData`, `createUserProfile`, etc.
-   **Error Handling**: Includes a centralized `handleAuthError` method to translate Firebase error codes into user-friendly messages.
-   **Role Management**: Contains static methods for role-based access control (`hasRole`, `isAdmin`, etc.).

## Hooks

### `useAuth` (`hooks/useAuth.ts`)
This is the primary hook for accessing authentication state and user data within components. It subscribes to Firebase's auth state, fetches user data from Firestore with React Query, and syncs the state with the Zustand store.

### `useAuthMutations` (`hooks/useAuthMutations.ts`)
This hook provides all functions that modify authentication state (login, register, update profile, etc.) using `useMutation` from React Query. It handles side effects like displaying toast notifications.

## Routing & Middleware

### Middleware (`middleware.ts`)
The `middleware.ts` file in Next.js allows you to run code before a request is completed. In this application, the middleware serves as a foundational layer for route protection, though the primary logic is currently handled on the client-side by components like `AuthGuard`.

The current implementation:
-   Defines lists of protected, admin-only, and teacher-only routes.
-   Uses a `matcher` in its config to run on all paths except for API routes and static assets (`_next/static`, `_next/image`, `favicon.ico`).
-   For now, it allows requests to proceed (`NextResponse.next()`) for all matched routes, deferring the actual authentication and authorization checks to client components. This approach is simple but can be extended to perform true server-side redirects by checking for an authentication token (e.g., from a cookie).

### Route Protection
-   **Route Groups**: The `(auth)` directory is a route group for all authentication-related pages.
-   **Protected Routes**: The `AuthGuard` and `RoleGuard` components are used to protect pages that require authentication or specific user roles.

## Components

-   **`AuthGuard` / `RoleGuard`**: Protects routes by checking for authentication and user roles.
-   **`AuthWrapper`**: Manages the display and transitions between login, register, and forgot password forms.
-   **Form Components**: `LoginForm`, `RegisterForm`, `ForgotPasswordForm` encapsulate form logic using `react-hook-form` and `zod`.
-   **UI Components**: A library of reusable components in `components/ui/` provides the application's design system.

## Styling & Theming

-   **`app/globals.css`**: Defines all CSS variables for light and dark themes using Tailwind CSS.
-   **`provider/ThemeProvider.tsx`**: A client component that applies the current theme and handles theme changes.
-   **`app/layout.tsx` Inline Script**: Prevents a "flash of incorrect theme" by applying the theme class from `localStorage` before React hydrates.

## Security Considerations

1.  **Firebase Security Rules**: It is critical to configure proper security rules for Firestore to prevent unauthorized data access.
2.  **Environment Variables**: All secret keys are stored in `.env.local` and are not exposed on the client-side unless prefixed with `NEXT_PUBLIC_`.
3.  **Input Validation**: All user input is validated on the client-side using Zod schemas.
4.  **Role-Based Access Control (RBAC)**: The system uses `RoleGuard` components and server-side checks to enforce permissions.

## Troubleshooting

### Common Issues

1.  **Authentication Failing**:
    -   Verify that the correct sign-in methods are enabled in the Firebase Console.
    -   Ensure your `.env.local` variables are correct.
2.  **User Not Persisting on Refresh**:
    -   Check the browser's DevTools to see if the `auth-storage` key is present in `localStorage`.
3.  **Redirect Loops**:
    -   Check the logic in `AuthGuard` and `middleware.ts` to ensure they don't conflict.
